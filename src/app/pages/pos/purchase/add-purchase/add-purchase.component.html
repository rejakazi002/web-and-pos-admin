<!-- Page Header -->
<section class="page-header-section">
  <div class="page-header-card">
    <div class="header-content">
      <div class="header-title">
        <h1 class="page-title">
          <mat-icon class="title-icon">shopping_cart</mat-icon>
          {{isViewMode ? "View Purchase" : (id ? "Edit Purchase" : "New Purchase")}}
        </h1>
      </div>
      <div class="header-actions">
        <button
          type="button"
          routerLink="/pos/purchase/purchase-list"
          mat-stroked-button
          class="back-btn">
          <mat-icon>arrow_back</mat-icon>
          <span>Back to List</span>
        </button>
      </div>
    </div>
  </div>
</section>

<!-- Main Form Section -->
<section id="new-purchase-section" class="form-section">
  <div class="form-container">
    <!-- Top Row: Supplier & Purchase Date -->
    <div class="form-row-top">
      <div class="form-group supplier-group">
        <mat-form-field appearance="outline" class="supplier-field">
          <mat-label>Supplier *</mat-label>
          <input
            matInput
            type="text"
            [(ngModel)]="supplierSearchQuery"
            (input)="onSupplierSearch($any($event.target).value)"
            (keyup)="onSupplierSearch($any($event.target).value)"
            placeholder="Search supplier by name or phone"
            [required]="!selectedSupplier"
          />
          <mat-icon matPrefix>business</mat-icon>
        </mat-form-field>
        <div class="supplier-search-results" *ngIf="searchSuppliers.length > 0">
          <div
            *ngFor="let supplier of searchSuppliers"
            (click)="onSelectSupplier(supplier)"
            class="supplier-search-item">
            <div class="supplier-item-info">
              <span class="supplier-item-name">{{supplier.name}}</span>
              <span class="supplier-item-phone" *ngIf="supplier.phone">{{supplier.phone}}</span>
            </div>
          </div>
        </div>
        <div class="selected-supplier" *ngIf="selectedSupplier">
          <div class="supplier-card">
            <mat-icon>business</mat-icon>
            <div class="supplier-details">
              <span class="supplier-name">{{selectedSupplier.name}}</span>
              <span class="supplier-phone" *ngIf="selectedSupplier.phone">{{selectedSupplier.phone}}</span>
            </div>
            <button mat-icon-button (click)="selectedSupplier = null; dataForm.patchValue({supplierId: null})" matTooltip="Remove Supplier">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>
      </div>
      <div class="form-group">
        <mat-label class="form-label">Purchase Date *</mat-label>
        <mat-form-field appearance="outline">
          <input 
            matInput 
            [matDatepicker]="picker" 
            placeholder="DD-MM-YYYY" 
            [formControl]="dataForm.get('purchaseDate')"
            [disabled]="isViewMode" />
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>
      </div>
    </div>

    <!-- Product Search -->
    <div class="product-search-section" *ngIf="!isViewMode">
      <div class="search-row">
        <mat-form-field appearance="outline" class="product-search-field">
          <mat-label>Search Product</mat-label>
          <input
            matInput
            type="text"
            [(ngModel)]="productSearchQuery"
            (input)="onProductSearch($any($event.target).value)"
            (keyup)="onProductSearch($any($event.target).value)"
            placeholder="Search by product name or SKU"
          />
          <mat-icon matPrefix>search</mat-icon>
          <mat-hint *ngIf="allProducts.length > 0">{{allProducts.length}} products available</mat-hint>
        </mat-form-field>
      </div>
      <div class="product-search-results" *ngIf="searchResultsWithVariations.length > 0">
        <div
          *ngFor="let item of searchResultsWithVariations"
          (click)="onSelectSearchItem(item)"
          class="product-search-item"
          [class.variation-item]="item.isVariation">
          <div class="product-item-info">
            <span class="product-item-name">{{item.displayName}}</span>
            <span class="product-item-details">
              Qty: {{item.stock}} | Purchase: {{shopInformation?.currency | currencyIcon}}{{item.purchasePrice | number:'1.2-2'}} | Sale: {{shopInformation?.currency | currencyIcon}}{{item.salePrice | number:'1.2-2'}}
              <span class="variation-badge" *ngIf="item.isVariation">Variation</span>
            </span>
            <span class="product-item-sku" *ngIf="item.sku">SKU: {{item.sku}}</span>
          </div>
        </div>
      </div>
      <div class="product-search-no-results" *ngIf="productSearchQuery && productSearchQuery.length > 0 && searchResultsWithVariations.length === 0 && allProducts.length > 0">
        <mat-icon>search_off</mat-icon>
        <span>No products found matching "{{productSearchQuery}}"</span>
      </div>
    </div>

    <!-- Products Table -->
    <div class="products-container" *ngIf="products.length > 0">
      <div class="table-card">
        <div class="table-header">
          <h3 class="table-title">
            <mat-icon>shopping_cart</mat-icon>
            Products in Purchase
            <span class="product-count">({{products.length}})</span>
          </h3>
        </div>
        <div class="table-responsive">
          <table class="modern-table">
            <thead>
              <tr>
                <th class="product-name-col">Product Name</th>
                <th class="quantity-col" *ngIf="!isViewMode">Quantity</th>
                <th class="quantity-col" *ngIf="isViewMode">Qty</th>
                <th class="price-col" *ngIf="!isViewMode">Purchase Price</th>
                <th class="price-col" *ngIf="isViewMode">Purchase Price</th>
                <th class="price-col" *ngIf="!isViewMode">Sale Price</th>
                <th class="price-col" *ngIf="isViewMode">Sale Price</th>
                <th class="price-col">Total</th>
                <th class="action-col" *ngIf="!isViewMode">Action</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let product of products; let i = index" class="table-row">
                <td class="product-name-cell">
                  <div class="product-info">
                    <mat-icon class="product-icon">inventory_2</mat-icon>
                    <div class="product-details">
                      <span class="product-name">{{product.name}}</span>
                      <span class="product-sku" *ngIf="product.sku">SKU: {{product.sku}}</span>
                    </div>
                  </div>
                </td>
                <td *ngIf="!isViewMode" class="quantity-control-cell">
                  <div class="quantity-controls">
                    <button
                      type="button"
                      class="qty-btn qty-decrease"
                      (click)="decrementQuantity(i)"
                      [disabled]="product.quantity <= 1"
                      matTooltip="Decrease quantity">
                      <mat-icon>remove</mat-icon>
                    </button>
                    <input
                      digitOnly
                      [(ngModel)]="product.quantity"
                      (ngModelChange)="updateQuantity(i, product.quantity)"
                      type="text"
                      class="qty-input"
                      min="1"
                    />
                    <button
                      type="button"
                      class="qty-btn qty-increase"
                      (click)="incrementQuantity(i)"
                      matTooltip="Increase quantity">
                      <mat-icon>add</mat-icon>
                    </button>
                  </div>
                </td>
                <td *ngIf="isViewMode" class="quantity-cell">
                  <span class="quantity-badge">{{ product.quantity }}</span>
                </td>
                <td *ngIf="!isViewMode" class="price-cell">
                  <input
                    type="number"
                    [(ngModel)]="product.purchasePrice"
                    (ngModelChange)="updatePurchasePrice(i, product.purchasePrice)"
                    class="price-input"
                    placeholder="0.00"
                    min="0"
                    step="0.01"
                  />
                </td>
                <td *ngIf="isViewMode" class="price-cell">
                  <span class="price-value">
                    {{shopInformation?.currency | currencyIcon}}{{ product.purchasePrice | number:'1.2-2'}}
                  </span>
                </td>
                <td *ngIf="!isViewMode" class="price-cell">
                  <input
                    type="number"
                    [(ngModel)]="product.salePrice"
                    (ngModelChange)="updateSalePrice(i, product.salePrice)"
                    class="price-input"
                    placeholder="0.00"
                    min="0"
                    step="0.01"
                  />
                </td>
                <td *ngIf="isViewMode" class="price-cell">
                  <span class="price-value">
                    {{shopInformation?.currency | currencyIcon}}{{ product.salePrice | number:'1.2-2'}}
                  </span>
                </td>
                <td class="price-cell total-cell">
                  <span class="total-value">
                    {{shopInformation?.currency | currencyIcon}}{{ product.total | number:'1.2-2'}}
                  </span>
                </td>
                <td *ngIf="!isViewMode" class="action-cell">
                  <button
                    mat-icon-button
                    color="warn"
                    class="delete-btn"
                    matTooltip="Remove product"
                    (click)="removeProduct(i)">
                    <mat-icon>delete_outline</mat-icon>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Main Content Grid: Form Fields & Summary -->
    <div class="main-content-grid">
      <!-- Left Side: Form Fields -->
      <div class="form-fields-section" *ngIf="!isViewMode">
        <div class="form-section-card">
          <h3 class="section-title">
            <mat-icon>settings</mat-icon>
            Purchase Settings
          </h3>
          <div class="form-row">
            <div class="form-group">
              <mat-label class="form-label">Discount Type</mat-label>
              <mat-form-field appearance="outline">
                <mat-select [formControl]="dataForm.get('discountType')" (selectionChange)="discountType = $event.value">
                  <mat-option *ngFor="let type of discountTypes" [value]="type.value">
                    {{type.viewValue}}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            <div class="form-group">
              <mat-label class="form-label">Discount</mat-label>
              <mat-form-field appearance="outline">
                <input
                  matInput
                  type="number"
                  [formControl]="dataForm.get('discount')"
                  (ngModelChange)="discount = $event"
                  placeholder="0.00"
                  min="0"
                  step="0.01"
                />
                <mat-icon matPrefix>local_offer</mat-icon>
              </mat-form-field>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <mat-label class="form-label">Tax</mat-label>
              <mat-form-field appearance="outline">
                <input
                  matInput
                  type="number"
                  [formControl]="dataForm.get('tax')"
                  (ngModelChange)="tax = $event"
                  placeholder="0.00"
                  min="0"
                  step="0.01"
                />
                <mat-icon matPrefix>receipt</mat-icon>
              </mat-form-field>
            </div>
            <div class="form-group">
              <mat-label class="form-label">Shipping</mat-label>
              <mat-form-field appearance="outline">
                <input
                  matInput
                  type="number"
                  [formControl]="dataForm.get('shipping')"
                  (ngModelChange)="shipping = $event"
                  placeholder="0.00"
                  min="0"
                  step="0.01"
                />
                <mat-icon matPrefix>local_shipping</mat-icon>
              </mat-form-field>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <mat-label class="form-label">Payment Type *</mat-label>
              <mat-form-field appearance="outline">
                <mat-select [formControl]="dataForm.get('paymentType')" (selectionChange)="paymentType = $event.value">
                  <mat-option *ngFor="let type of paymentTypes" [value]="type.value">
                    {{type.viewValue}}
                  </mat-option>
                </mat-select>
                <mat-icon matPrefix>payment</mat-icon>
              </mat-form-field>
            </div>
            <div class="form-group" *ngIf="paymentType !== 'due'">
              <mat-label class="form-label">Paid Amount *</mat-label>
              <mat-form-field appearance="outline">
                <input
                  matInput
                  type="number"
                  [formControl]="dataForm.get('paidAmount')"
                  (ngModelChange)="paidAmount = $event"
                  placeholder="0.00"
                  min="0"
                  step="0.01"
                  [max]="grandTotal"
                />
                <mat-icon matPrefix>attach_money</mat-icon>
              </mat-form-field>
            </div>
          </div>
          <div class="form-row" *ngIf="paymentType !== 'due'">
            <div class="form-group full-width">
              <mat-label class="form-label">Change</mat-label>
              <mat-form-field appearance="outline">
                <input
                  matInput
                  type="text"
                  [value]="((paidAmount || 0) - grandTotal) | number:'1.2-2'"
                  readonly
                />
                <mat-icon matPrefix>account_balance_wallet</mat-icon>
              </mat-form-field>
            </div>
          </div>
          <div class="form-row" *ngIf="paymentType === 'due'">
            <div class="form-group full-width">
              <mat-label class="form-label">Due Amount</mat-label>
              <mat-form-field appearance="outline">
                <input
                  matInput
                  type="text"
                  [value]="grandTotal | number:'1.2-2'"
                  readonly
                />
                <mat-icon matPrefix>account_balance_wallet</mat-icon>
              </mat-form-field>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group full-width">
              <mat-label class="form-label">Reference</mat-label>
              <mat-form-field appearance="outline">
                <input
                  matInput
                  type="text"
                  [formControl]="dataForm.get('reference')"
                  (ngModelChange)="reference = $event"
                  placeholder="Transaction ID, Cheque No, etc."
                />
                <mat-icon matPrefix>description</mat-icon>
              </mat-form-field>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group full-width">
              <mat-label class="form-label">Notes</mat-label>
              <mat-form-field appearance="outline">
                <textarea
                  matInput
                  rows="3"
                  [formControl]="dataForm.get('notes')"
                  (ngModelChange)="notes = $event"
                  placeholder="Additional notes about this purchase"
                ></textarea>
                <mat-icon matPrefix>notes</mat-icon>
              </mat-form-field>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Side: Summary -->
      <div class="summary-section">
        <div class="summary-card">
          <h3 class="summary-title">
            <mat-icon>receipt</mat-icon>
            Purchase Summary
          </h3>
          <div class="summary-content">
            <div class="summary-row">
              <span class="summary-label">Sub Total</span>
              <span class="summary-value">{{shopInformation?.currency | currencyIcon}}{{ subTotal | number:'1.2-2'}}</span>
            </div>
            <div class="summary-row discount-row" *ngIf="finalDiscount > 0">
              <span class="summary-label">Discount</span>
              <span class="summary-value discount-value">-{{shopInformation?.currency | currencyIcon}}{{ finalDiscount | number:'1.2-2'}}</span>
            </div>
            <div class="summary-row" *ngIf="tax > 0">
              <span class="summary-label">Tax</span>
              <span class="summary-value">{{shopInformation?.currency | currencyIcon}}{{ tax | number:'1.2-2'}}</span>
            </div>
            <div class="summary-row" *ngIf="shipping > 0">
              <span class="summary-label">Shipping</span>
              <span class="summary-value">{{shopInformation?.currency | currencyIcon}}{{ shipping | number:'1.2-2'}}</span>
            </div>
            <div class="summary-row total-row">
              <span class="summary-label">Grand Total</span>
              <span class="summary-value total-value">{{shopInformation?.currency | currencyIcon}}{{ grandTotal | number:'1.2-2'}}</span>
            </div>
            <div class="summary-row" *ngIf="paymentType !== 'due'">
              <span class="summary-label">Paid Amount</span>
              <span class="summary-value paid-value">{{shopInformation?.currency | currencyIcon}}{{ (paidAmount || 0) | number:'1.2-2'}}</span>
            </div>
            <div class="summary-row due-row" *ngIf="dueAmount > 0">
              <span class="summary-label">Due Amount</span>
              <span class="summary-value due-value">{{shopInformation?.currency | currencyIcon}}{{ dueAmount | number:'1.2-2'}}</span>
            </div>
            <div class="summary-row" *ngIf="paymentType !== 'due' && paidAmount > grandTotal">
              <span class="summary-label">Change</span>
              <span class="summary-value change-value">{{shopInformation?.currency | currencyIcon}}{{ ((paidAmount || 0) - grandTotal) | number:'1.2-2'}}</span>
            </div>
          </div>
          <div class="summary-actions" *ngIf="!isViewMode">
            <button
              type="button"
              mat-stroked-button
              (click)="onCancel()"
              class="cancel-btn">
              Cancel
            </button>
            <button
              type="button"
              mat-raised-button
              color="primary"
              (click)="onSubmit()"
              [disabled]="isLoading || dataForm.invalid || products.length === 0 || !selectedSupplier"
              class="submit-btn">
              <mat-icon *ngIf="!isLoading">{{id ? 'update' : 'save'}}</mat-icon>
              <mat-spinner *ngIf="isLoading" diameter="20" class="spinner"></mat-spinner>
              <span>{{id ? 'Update Purchase' : 'Save Purchase'}}</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Loading Spinner -->
<app-page-loader *ngIf="isLoading"></app-page-loader>

