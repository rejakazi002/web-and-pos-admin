<!-- Page Header -->
<section class="page-header-section">
  <div class="page-header-card">
    <div class="header-content">
      <div class="header-title">
        <h1 class="page-title">
          <mat-icon class="title-icon">admin_panel_settings</mat-icon>
          Branch Access Management
        </h1>
        <p class="page-subtitle">Manage user access to branches</p>
      </div>
      <div class="header-actions">
        <button
          type="button"
          (click)="toggleForm()"
          mat-raised-button
          color="primary"
          class="add-btn">
          <mat-icon>{{ showForm ? 'close' : 'add' }}</mat-icon>
          <span>{{ showForm ? 'Cancel' : 'Assign Access' }}</span>
        </button>
      </div>
    </div>
  </div>
</section>

<!-- Assign Access Form -->
<section *ngIf="showForm" class="form-section">
  <div class="form-card">
    <h2>Assign Branch Access</h2>
    <form [formGroup]="accessForm" (ngSubmit)="onSubmit()">
      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>User</mat-label>
          <mat-select formControlName="userId" required>
            <mat-option *ngFor="let user of users" [value]="user._id">
              {{ user.name || user.username || user.email }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="accessForm.get('userId')?.hasError('required')">
            User is required
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Branches</mat-label>
          <mat-select formControlName="branches" multiple required>
            <mat-option *ngFor="let branch of branches" [value]="branch._id">
              {{ branch.websiteName }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="accessForm.get('branches')?.hasError('required')">
            At least one branch is required
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-row">
        <h3>Permissions</h3>
        <div formGroupName="permissions" class="permissions-group">
          <mat-checkbox formControlName="canView">Can View</mat-checkbox>
          <mat-checkbox formControlName="canEdit">Can Edit</mat-checkbox>
          <mat-checkbox formControlName="canDelete">Can Delete</mat-checkbox>
          <mat-checkbox formControlName="canTransfer">Can Transfer</mat-checkbox>
          <mat-checkbox formControlName="canApproveTransfer">Can Approve Transfer</mat-checkbox>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" mat-button (click)="toggleForm()">Cancel</button>
        <button type="submit" mat-raised-button color="primary" [disabled]="accessForm.invalid || isLoading">
          Assign Access
        </button>
      </div>
    </form>
  </div>
</section>

<!-- Loading Spinner -->
<app-page-loader *ngIf="isLoading"></app-page-loader>

<!-- Branch Access List -->
<section *ngIf="!isLoading" class="table-section">
  <div class="table-card">
    <div class="table-container">
      <table mat-table [dataSource]="branchAccessList" class="access-table">
        <!-- User Column -->
        <ng-container matColumnDef="user">
          <th mat-header-cell *matHeaderCellDef>User</th>
          <td mat-cell *matCellDef="let access">
            <div class="user-info">
              <div class="user-name">{{ access.user?.name || access.user?.username || access.user?.email || 'N/A' }}</div>
              <div class="user-email">{{ access.user?.email || '' }}</div>
            </div>
          </td>
        </ng-container>

        <!-- Branches Column -->
        <ng-container matColumnDef="branches">
          <th mat-header-cell *matHeaderCellDef>Branches</th>
          <td mat-cell *matCellDef="let access">
            <div class="branches-list">
              <span *ngFor="let branch of access.branches" class="branch-chip">
                {{ getBranchNames([branch._id || branch]) }}
              </span>
            </div>
          </td>
        </ng-container>

        <!-- Permissions Column -->
        <ng-container matColumnDef="permissions">
          <th mat-header-cell *matHeaderCellDef>Permissions</th>
          <td mat-cell *matCellDef="let access">
            <div class="permissions-list">
              <span *ngIf="access.permissions?.canView" class="permission-chip">View</span>
              <span *ngIf="access.permissions?.canEdit" class="permission-chip">Edit</span>
              <span *ngIf="access.permissions?.canDelete" class="permission-chip">Delete</span>
              <span *ngIf="access.permissions?.canTransfer" class="permission-chip">Transfer</span>
              <span *ngIf="access.permissions?.canApproveTransfer" class="permission-chip">Approve</span>
            </div>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let access">
            <button
              mat-icon-button
              matTooltip="Revoke All Access"
              (click)="revokeAccess(access)"
              color="warn">
              <mat-icon>block</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['user', 'branches', 'permissions', 'actions']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['user', 'branches', 'permissions', 'actions'];"></tr>
      </table>
    </div>
  </div>
</section>

<app-no-content *ngIf="!isLoading && branchAccessList.length === 0" [text]="'No branch access assigned'"></app-no-content>

