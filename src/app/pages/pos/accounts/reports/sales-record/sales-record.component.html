<section class="page-header-section">
  <div class="page-header-card">
    <div class="header-content">
      <div class="header-title">
        <h1 class="page-title">
          <mat-icon class="title-icon">receipt_long</mat-icon>
          Sales Record
        </h1>
      </div>
    </div>
  </div>
</section>

<section class="filter-section">
  <div class="filter-card">
    <div class="filter-content">
      <mat-form-field appearance="outline">
        <mat-label>Category</mat-label>
        <mat-select [(ngModel)]="selectedCategories" (selectionChange)="onCategoryChange()" multiple>
          <mat-option *ngFor="let category of categories" [value]="category._id">
            {{ category.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Sub Category</mat-label>
        <mat-select [(ngModel)]="selectedSubCategories" (selectionChange)="onSubCategoryChange()" multiple [disabled]="selectedCategories.length === 0">
          <mat-option *ngFor="let subCategory of subCategories" [value]="subCategory._id">
            {{ subCategory.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Brand</mat-label>
        <mat-select [(ngModel)]="selectedBrands" (selectionChange)="onBrandChange()" multiple>
          <mat-option *ngFor="let brand of brands" [value]="brand._id">
            {{ brand.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Filter Date</mat-label>
        <mat-select [(ngModel)]="dateFilterType" (selectionChange)="onDateFilterTypeChange()">
          <mat-option value="all">All Dates</mat-option>
          <mat-option value="today">Today</mat-option>
          <mat-option value="yesterday">Yesterday</mat-option>
          <mat-option value="last7days">Last 7 Days</mat-option>
          <mat-option value="last30days">Last 30 Days</mat-option>
          <mat-option value="thisMonth">This Month</mat-option>
          <mat-option value="custom">Custom Range</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" *ngIf="dateFilterType === 'custom'">
        <mat-label>Start Date</mat-label>
        <input matInput [matDatepicker]="startPicker" [(ngModel)]="startDate" (dateChange)="onDateChange()" placeholder="Select start date">
        <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
        <mat-datepicker #startPicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline" *ngIf="dateFilterType === 'custom'">
        <mat-label>End Date</mat-label>
        <input matInput [matDatepicker]="endPicker" [(ngModel)]="endDate" (dateChange)="onDateChange()" placeholder="Select end date">
        <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
        <mat-datepicker #endPicker></mat-datepicker>
      </mat-form-field>

      <button mat-raised-button color="primary" (click)="loadSales()" [disabled]="isLoading">
        <mat-icon>refresh</mat-icon>
        Refresh Data
      </button>
    </div>
    <div class="export-toolbar" *ngIf="!isLoading && filteredSalesData.length > 0">
      <button
        mat-stroked-button
        class="export-btn"
        (click)="exportCSV()"
        matTooltip="Export CSV">
        <mat-icon>description</mat-icon>
        <span>Export CSV</span>
      </button>

      <button
        mat-stroked-button
        class="export-btn"
        (click)="exportExcel()"
        matTooltip="Export Excel">
        <mat-icon>table_chart</mat-icon>
        <span>Export Excel</span>
      </button>

      <button
        mat-stroked-button
        class="export-btn"
        (click)="printReport()"
        matTooltip="Print">
        <mat-icon>print</mat-icon>
        <span>Print</span>
      </button>

      <button
        mat-stroked-button
        class="export-btn"
        (click)="showColumnsInfo()"
        matTooltip="Columns">
        <mat-icon>view_column</mat-icon>
        <span>Columns</span>
      </button>

      <button
        mat-stroked-button
        class="export-btn"
        (click)="exportPDF()"
        matTooltip="Export PDF">
        <mat-icon>picture_as_pdf</mat-icon>
        <span>Export PDF</span>
      </button>
    </div>
  </div>
</section>

<app-page-loader *ngIf="isLoading"></app-page-loader>

<section class="content-section" *ngIf="!isLoading">
  <div class="summary-section" *ngIf="filteredSalesData.length > 0">
    <div class="summary-grid">
      <div class="summary-item highlight">
        <h4>Total Amount</h4>
        <p class="large">{{shopInfo?.currency | currencyIcon}}{{ summary.totalAmount || 0 | number:'1.2-2'}}</p>
      </div>
      <div class="summary-item">
        <h4>Total Items</h4>
        <p>{{ summary.totalSales || 0 }}</p>
      </div>
      <div class="summary-item">
        <h4>Total Quantity</h4>
        <p>{{ summary.totalQuantity || 0 }}</p>
      </div>
      <div class="summary-item">
        <h4>Total Transactions</h4>
        <p>{{ summary.totalTransactions || 0 }}</p>
      </div>
    </div>
  </div>

  <div class="report-card" *ngIf="filteredSalesData.length > 0">
    <!-- Shop Header (for print) -->
    <div class="shop-header print-only" *ngIf="shopInfo">
      <div class="shop-name">{{ shopInfo.websiteName || 'Shop Name' }}</div>
      <div class="shop-address" *ngIf="shopInfo.addresses && shopInfo.addresses.length > 0">
        {{ shopInfo.addresses[0].value }}
      </div>
      <div class="shop-phone" *ngIf="shopInfo.phones && shopInfo.phones.length > 0">
        {{ shopInfo.phones[0].value }}
      </div>
      <div class="report-date">{{ getReportDate() }}</div>
    </div>

    <!-- Table for no filters (image format) -->
    <div class="table-responsive" *ngIf="!hasFilters">
      <table mat-table [dataSource]="dataSource" class="modern-table sales-table">
        <ng-container matColumnDef="serialNo">
          <th mat-header-cell *matHeaderCellDef>S/N</th>
          <td mat-cell *matCellDef="let item">{{ item.serialNo }}</td>
        </ng-container>

        <ng-container matColumnDef="item">
          <th mat-header-cell *matHeaderCellDef>ITEM</th>
          <td mat-cell *matCellDef="let item">{{ item.item }}</td>
        </ng-container>

        <ng-container matColumnDef="qty">
          <th mat-header-cell *matHeaderCellDef>QTY</th>
          <td mat-cell *matCellDef="let item">{{ item.qty }}</td>
        </ng-container>

        <ng-container matColumnDef="price">
          <th mat-header-cell *matHeaderCellDef>PRICE</th>
          <td mat-cell *matCellDef="let item">{{shopInfo?.currency | currencyIcon}}{{ item.price | number:'1.2-2'}}</td>
        </ng-container>

        <ng-container matColumnDef="cost">
          <th mat-header-cell *matHeaderCellDef>COST</th>
          <td mat-cell *matCellDef="let item">{{shopInfo?.currency | currencyIcon}}{{ item.cost | number:'1.2-2'}}</td>
        </ng-container>

        <ng-container matColumnDef="profit">
          <th mat-header-cell *matHeaderCellDef>PROFIT</th>
          <td mat-cell *matCellDef="let item">{{shopInfo?.currency | currencyIcon}}{{ item.profit | number:'1.2-2'}}</td>
        </ng-container>

        <ng-container matColumnDef="notes">
          <th mat-header-cell *matHeaderCellDef>NOTES</th>
          <td mat-cell *matCellDef="let item">{{ item.notes }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <!-- Sub-Total Row -->
      <div class="subtotal-row">
        <div class="subtotal-label">SUB-TOTAL AMOUNT:</div>
        <div class="subtotal-values">
          <span class="subtotal-item">QTY: <strong>{{ summary.totalQuantity }}</strong></span>
          <span class="subtotal-item">PRICE: <strong>{{shopInfo?.currency | currencyIcon}}{{ summary.totalAmount | number:'1.2-2'}}</strong></span>
          <span class="subtotal-item">COST: <strong>{{shopInfo?.currency | currencyIcon}}{{ summary.totalCost | number:'1.2-2'}}</strong></span>
          <span class="subtotal-item">PROFIT: <strong>{{shopInfo?.currency | currencyIcon}}{{ summary.totalProfit | number:'1.2-2'}}</strong></span>
        </div>
      </div>
    </div>

    <!-- Detailed table for filters applied -->
    <div class="table-responsive" *ngIf="hasFilters">
      <h2>Sales Record Details</h2>
      <table mat-table [dataSource]="dataSource" class="modern-table">
        <ng-container matColumnDef="invoiceNo">
          <th mat-header-cell *matHeaderCellDef>Invoice No</th>
          <td mat-cell *matCellDef="let item">{{ item.invoiceNo }}</td>
        </ng-container>

        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef>Date</th>
          <td mat-cell *matCellDef="let item">{{ item.date | date:'short' }}</td>
        </ng-container>

        <ng-container matColumnDef="productName">
          <th mat-header-cell *matHeaderCellDef>Product Name</th>
          <td mat-cell *matCellDef="let item">{{ item.productName }}</td>
        </ng-container>

        <ng-container matColumnDef="category">
          <th mat-header-cell *matHeaderCellDef>Category</th>
          <td mat-cell *matCellDef="let item">{{ item.category }}</td>
        </ng-container>

        <ng-container matColumnDef="subCategory">
          <th mat-header-cell *matHeaderCellDef>Sub Category</th>
          <td mat-cell *matCellDef="let item">{{ item.subCategory }}</td>
        </ng-container>

        <ng-container matColumnDef="brand">
          <th mat-header-cell *matHeaderCellDef>Brand</th>
          <td mat-cell *matCellDef="let item">{{ item.brand }}</td>
        </ng-container>

        <ng-container matColumnDef="quantity">
          <th mat-header-cell *matHeaderCellDef>Quantity</th>
          <td mat-cell *matCellDef="let item">{{ item.quantity }}</td>
        </ng-container>

        <ng-container matColumnDef="unitPrice">
          <th mat-header-cell *matHeaderCellDef>Unit Price</th>
          <td mat-cell *matCellDef="let item">{{shopInfo?.currency | currencyIcon}}{{ item.unitPrice | number:'1.2-2'}}</td>
        </ng-container>

        <ng-container matColumnDef="total">
          <th mat-header-cell *matHeaderCellDef>Total</th>
          <td mat-cell *matCellDef="let item">{{shopInfo?.currency | currencyIcon}}{{ item.total | number:'1.2-2'}}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['invoiceNo', 'date', 'productName', 'category', 'subCategory', 'brand', 'quantity', 'unitPrice', 'total']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['invoiceNo', 'date', 'productName', 'category', 'subCategory', 'brand', 'quantity', 'unitPrice', 'total'];"></tr>
      </table>

      <!-- Total Row -->
      <div class="total-row">
        <div class="total-label">Total:</div>
        <div class="total-value">{{shopInfo?.currency | currencyIcon}}{{ summary.totalAmount | number:'1.2-2'}}</div>
      </div>
    </div>
  </div>

  <div class="no-data" *ngIf="!isLoading && filteredSalesData.length === 0">
    <mat-icon>inbox</mat-icon>
    <p>No sales data found for the selected filters</p>
  </div>
</section>

