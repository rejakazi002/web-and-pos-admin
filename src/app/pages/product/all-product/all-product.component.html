<div class="container">
  <div class="header">

    <form class="table-search" #searchForm=ngForm>
      <input type="text"
             name="searchTerm"
             autocomplete="off"
             [(ngModel)]="searchQuery"
             placeholder="Search">
      @if (!searchQuery) {
        <button>
          <mat-icon>search</mat-icon>
        </button>
      } @else {
        <button (click)="onClearSearch()">
          <mat-icon>close</mat-icon>
        </button>
      }
    </form> <!-- END! table-search -->

    <div class="right">
<!--      <a mat-button class="add-product-btn" color="primary"-->
<!--         [routerLink]="[productSetting?.productType === 'digitalProduct' ? '/product/add-digital-product' : '/product/add-product']">-->
<!--        <mat-icon>add</mat-icon>-->
<!--        Add Product-->
<!--      </a>-->



      @if (adminShopId === '679511745a429b7bb55421c4' || adminShopId === '68ac56c29520b2059226afae'){
        <a mat-button class="add-product-btn" color="primary"
           (click)="openConfirmDialog('syncProduct')">
          <mat-icon>add</mat-icon>
          Sync Products
        </a>
      }


      <a mat-button class="add-product-btn" color="primary"
         [routerLink]="['/product/add-product']">
        <mat-icon>add</mat-icon>
        Add Product
      </a>
    </div> <!-- END! right -->

  </div> <!-- END! header -->

  <div class="content">

    <div class="table-tab-container" [class.table-header]="isPopupVisible">
      <div class="table-tab-content">
        @for (data of tableTabData; track $index) {
          @if (data.value !== 'trash') {
            <p (click)="onTabChange(data.value)" [ngClass]="{'active-tab': selectedTab == data.value}">
              {{ data.viewValue }} <span class="tab-data-count">{{ totalData }}</span>
            </p>
          }
        }

      </div>


      <div class="right-area">

        <label class="download-box">
          <svg style="transform: rotate(180deg);" fill="#0a55e5" height="20px" width="20px" viewBox="0 0 471.2 471.2" xmlns="http://www.w3.org/2000/svg">
            <g>
              <path d="M457.7,230.15c-7.5,0-13.5,6-13.5,13.5v122.8c0,33.4-27.2,60.5-60.5,60.5H87.5c-33.4,0-60.5-27.2-60.5-60.5v-124.8
      c0-7.5-6-13.5-13.5-13.5s-13.5,6-13.5,13.5v124.8c0,48.3,39.3,87.5,87.5,87.5h296.2c48.3,0,87.5-39.3,87.5-87.5v-122.8
      C471.2,236.25,465.2,230.15,457.7,230.15z"/>
              <path d="M226.1,346.75c2.6,2.6,6.1,4,9.5,4s6.9-1.3,9.5-4l85.8-85.8c5.3-5.3,5.3-13.8,0-19.1c-5.3-5.3-13.8-5.3-19.1,0
      l-62.7,62.8V30.75c0-7.5-6-13.5-13.5-13.5s-13.5,6-13.5,13.5v273.9l-62.8-62.8c-5.3-5.3-13.8-5.3-19.1,0c-5.3,5.3-5.3,13.8,0,19.1
      L226.1,346.75z"/>
            </g>
          </svg>
          <p style="color:#0a55e5; margin: 0;">Import</p>
          <input type="file" (change)="onFileSelect($event)" accept=".csv" />
        </label>
<!--        <div class="per-page-control">-->
<!--          <span class="per-page-caption">Per page</span>-->
<!--          <mat-form-field appearance="outline" class="per-page-field" style="width: 88px;">-->
<!--            <mat-select [aria-label]="'Per page'" [value]="dataPerPage" (selectionChange)="onChangePerPage($event.value)">-->
<!--              <mat-option [value]="10">10</mat-option>-->
<!--              <mat-option [value]="50">50</mat-option>-->
<!--              <mat-option [value]="100">100</mat-option>-->
<!--              <mat-option [value]="100">150</mat-option>-->
<!--              <mat-option [value]="100">200</mat-option>-->
<!--              <mat-option [value]="100">250</mat-option>-->
<!--              <mat-option [value]="100">300</mat-option>-->
<!--              <mat-option [value]="100">350</mat-option>-->
<!--            </mat-select>-->
<!--          </mat-form-field>-->
<!--        </div>-->
        <div class="sort">
          <button mat-raised-button color="primary" [matMenuTriggerFor]="menuShow">
            {{selectedPagination ? selectedPagination : '10'}}
            <mat-icon>arrow_drop_down</mat-icon>
          </button>
          <mat-menu #menuShow="matMenu">
            <button mat-menu-item (click)="onChangePerPage(10)" [class.dropdown-active]="selectedPagination === 10">10</button>
            <button mat-menu-item (click)="onChangePerPage(20)" [class.dropdown-active]="selectedPagination === 20">20</button>
            <button mat-menu-item (click)="onChangePerPage(30)" [class.dropdown-active]="selectedPagination === 30">30</button>
            <button mat-menu-item (click)="onChangePerPage(40)" [class.dropdown-active]="selectedPagination === 40">40</button>
            <button mat-menu-item (click)="onChangePerPage(50)" [class.dropdown-active]="selectedPagination === 50">50</button>
            <button mat-menu-item (click)="onChangePerPage(60)" [class.dropdown-active]="selectedPagination === 50">60</button>
            <button mat-menu-item (click)="onChangePerPage(70)" [class.dropdown-active]="selectedPagination === 50">70</button>
            <button mat-menu-item (click)="onChangePerPage(80)" [class.dropdown-active]="selectedPagination === 50">80</button>
            <button mat-menu-item (click)="onChangePerPage(100)" [class.dropdown-active]="selectedPagination === 100">100</button>
            <button mat-menu-item (click)="onChangePerPage(200)" [class.dropdown-active]="selectedPagination === 200">200</button>
            <button mat-menu-item (click)="onChangePerPage(250)" [class.dropdown-active]="selectedPagination === 250">250</button>
            <button mat-menu-item (click)="onChangePerPage(300)" [class.dropdown-active]="selectedPagination === 300">300</button>
            <button mat-menu-item (click)="onChangePerPage(350)" [class.dropdown-active]="selectedPagination === 350">350</button>
            <button mat-menu-item (click)="onChangePerPage(450)" [class.dropdown-active]="selectedPagination === 450">450</button>
          </mat-menu>
        </div>
        @if(selectedTab === 'trash' && adminRole === 'owner'){
          <button   (click)="openConfirmDialog('trash')">
            <svg fill="#000000" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 593.727 593.727" xml:space="preserve"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <g> <path d="M491.362,593.727H102.374c-20.865,0-37.84-16.975-37.84-37.84v-448.5h464.668v448.5 C529.202,576.752,512.228,593.727,491.362,593.727z M79.677,122.529v433.357c0,12.516,10.182,22.697,22.697,22.697h388.989 c12.516,0,22.697-10.182,22.697-22.697V122.529H79.677z"></path> </g> <g> <path d="M550.8,91.913H42.927V58.382c0-20.86,16.973-37.831,37.835-37.831h192.852C276.618,8.58,286.12,0,297.506,0 c11.399,0,20.907,8.578,23.905,20.551H512.97c20.859,0,37.83,16.971,37.83,37.831V91.913L550.8,91.913z M58.07,76.77h477.587 V58.382c0-12.51-10.178-22.688-22.688-22.688h-205.57l-0.148-7.42c-0.145-7.24-4.516-13.131-9.745-13.131 c-5.219,0-9.586,5.893-9.736,13.136l-0.154,7.415H80.762c-12.512,0-22.692,10.177-22.692,22.688V76.77z"></path> </g> <g> <path d="M144.621,546.275c-15.949,0-28.924-12.977-28.924-28.926V196.011c0-15.95,12.975-28.926,28.924-28.926 c15.95,0,28.926,12.976,28.926,28.926V517.35C173.547,533.299,160.571,546.275,144.621,546.275z M144.621,182.228 c-7.599,0-13.781,6.183-13.781,13.783V517.35c0,7.6,6.183,13.783,13.781,13.783c7.601,0,13.783-6.184,13.783-13.783V196.011 C158.404,188.411,152.222,182.228,144.621,182.228z"></path> </g> <g> <path d="M243.094,546.275c-15.95,0-28.925-12.977-28.925-28.926V196.011c0-15.95,12.976-28.926,28.925-28.926 c15.949,0,28.925,12.976,28.925,28.926V517.35C272.019,533.299,259.043,546.275,243.094,546.275z M243.094,182.228 c-7.6,0-13.782,6.183-13.782,13.783V517.35c0,7.6,6.183,13.783,13.782,13.783s13.782-6.184,13.782-13.783V196.011 C256.876,188.411,250.694,182.228,243.094,182.228z"></path> </g> <g> <path d="M341.565,546.275c-15.949,0-28.926-12.977-28.926-28.926V196.011c0-15.95,12.977-28.926,28.926-28.926 s28.926,12.976,28.926,28.926V517.35C370.491,533.299,357.515,546.275,341.565,546.275z M341.565,182.228 c-7.6,0-13.783,6.183-13.783,13.783V517.35c0,7.6,6.184,13.783,13.783,13.783s13.783-6.184,13.783-13.783V196.011 C355.347,188.411,349.165,182.228,341.565,182.228z"></path> </g> <g> <path d="M440.038,546.275c-15.955,0-28.934-12.977-28.934-28.926V196.011c0-15.95,12.979-28.926,28.934-28.926 c15.949,0,28.924,12.976,28.924,28.926V517.35C468.962,533.299,455.987,546.275,440.038,546.275z M440.038,182.228 c-7.605,0-13.791,6.183-13.791,13.783V517.35c0,7.6,6.186,13.783,13.791,13.783c7.6,0,13.781-6.184,13.781-13.783V196.011 C453.819,188.411,447.638,182.228,440.038,182.228z"></path> </g> </g> </g></svg>
            Empty Trash
          </button>
        }

          <app-pagination
            [totalData]="totalData"
            [dataPerPage]="dataPerPage"
            [currentPage]="currentPage"
            (pageChange)="onPageChanged($event)">
          </app-pagination>

      </div>

    </div> <!-- END Tab & Pagination View -->




    <div class="sub-content">
      <div class="table-wrapper">
        <table>
          <tr class="td-border first-heading-row" [class.table-header]="isPopupVisible">
            <th class="t-checkbox">
              <mat-checkbox color="primary" [indeterminate]="isIndeterminate" #matCheckbox
                            (change)="onAllSelectChange($event)"></mat-checkbox>
            </th>
            <th>SL</th>
            <th>Image</th>
            <th>Name</th>
            <th class="t-head-action">
              <div class="filter">
              <span>Category</span>
              <button [class.active]="activeFilter1 !== null" [matMenuTriggerFor]="menuStatus"
                      [matTooltip]="activeFilter1 ? 'Filter Applied' : 'Apply Filter'">
                <span class="material-icons">filter_alt</span>
              </button>
              <div class="sort">
                <mat-menu #menuStatus="matMenu">
                  <button mat-menu-item (click)="filterData(null, 'category', null)">
                    {{ 'None' }}
                  </button>
                  @for (data of categories; track $index) {
                    <button mat-menu-item (click)="filterData(data._id, 'category', $index)"
                            [class.dropdown-active]="activeFilter1 === $index">
                      {{ data.name }}
                    </button>
                  }
                </mat-menu>
              </div>
              </div>
            </th>
            <th class="t-head-action">
              <div class="filter">
              <span>Sub Category</span>
              <button [class.active]="activeFilter2 !== null" [matMenuTriggerFor]="menuStatus2"
                      [matTooltip]="activeFilter2 ? 'Filter Applied' : 'Apply Filter'">
                <span class="material-icons">filter_alt</span>
              </button>
              <div class="sort">
                <mat-menu #menuStatus2="matMenu">
                  <button mat-menu-item (click)="filterData(null, 'subCategory', null)">
                    {{ 'None' }}
                  </button>
                  @for (data of subCategories; track $index) {
                    <button mat-menu-item (click)="filterData(data?._id, 'subCategory', $index)"
                            [class.dropdown-active]="activeFilter2 === $index">
                      {{ data?.name }}
                    </button>
                  }
                </mat-menu>
              </div>
              </div>
            </th>
                        <th class="t-head-action">
                          <span>Priority</span>
                          <button (click)="sortData({priority: -1}, 1)" [class.active]="activeSort === 1"
                                  [matTooltip]="activeSort === 1 ? 'Sort Applied' : 'Apply Sort'">
                            <span class="material-icons">arrow_downward</span>
                          </button>
                        </th>
            <th>Tags</th>
            <th>Status</th>
            @if(this.selectedTab === 'trash'){
              <th >Deletion Days</th>
            }
            <th>Actions</th>
          </tr> <!-- END Table Head -->

          @defer (when !isLoading) {
            <tr class="td-gap"></tr>
            @if (allTableData.length) {
              @for (data of allTableData; track data._id; let i = $index;) {
                <ng-container>
                  <tr class="td-border" (click)="onTableRowClick(data._id)" [class.selected]="data.select">
                    <td class="t-checkbox">
                      <mat-checkbox
                        color="primary"
                        (click)="$event.stopPropagation()"
                        class="t-mat-checkbox"
                        [(ngModel)]="data.select"
                        (ngModelChange)="onCheckChange($event, data._id)">
                      </mat-checkbox>
                    </td>
                    <td>{{dataPerPage *(currentPage-1)+i+1}}</td>
                    <td class="img-wrapper">
                      <img class="table-image"
                           matTooltip="Click to preview image"
                           (click)="openGallery($event, data.images)"
                           [src]="data.images?.length ? data.images[0] + '?&auto=format&w=384' : '/assets/images/png/placeholder.png'"
                           [alt]="''">
                    </td>
                    <td>
                      <a style="color: #1d1d1d" [matTooltip]="data.name" (click)="handleProductNameLinkable($event)" [attr.href]="'//' + shop?.domain+'/product-details/'+data?.slug" target="_blank">{{ (data.name | titlecase)| limitText: 45 }}</a>
                    </td>
                    <td>
                      <p>{{ data.category?.name ?? '-' }}</p>
                    </td>
                    <td>
                      <p>{{ data.subCategory?.name ?? '-' }}</p>
                    </td>
                    <td>
                      <p>{{ data.priority ?? '-' }}</p>
                    </td>
                    <td>
                      @if (data?.tags?.length) {

                        @for (item of data?.tags; track item?._id; let i = $index) {
                          <p> {{ item?.name ?? '-' }}{{ i < (data?.tags.length - 1) ? ',' : '' }}</p>
                        }
                      } @else {
                        <p>{{ '-' }}</p>
                      }

                    </td>
                    <td>
                      <p><span [ngClass]="getStatusClass(data.status)">{{ data.status | titlecase }}</span></p>
                    </td>
                    @if(this.selectedTab === 'trash'){
                      <td>
                        {{ data?.deleteDateString ? (data?.deleteDateString | daysRemaining) : '-' }}
                      </td>
                    }
                    <td class="action-drop-button">
                      <button mat-icon-button [matMenuTriggerFor]="tableMenu" (click)="$event.stopPropagation()">
                        <mat-icon>more_vert</mat-icon>
                      </button>
                      <mat-menu #tableMenu="matMenu">
<!--                        <button [routerLink]="[productSetting?.productType === 'digitalProduct' ? '/product/edit-digital-product' : '/product/edit', data._id]" mat-menu-item>-->
<!--                          <mat-icon>edit</mat-icon>-->
<!--                          Edit-->
<!--                        </button>  -->

                        <button [routerLink]="['/product/edit', data._id]" mat-menu-item>
                          <mat-icon>edit</mat-icon>
                          Edit
                        </button>
                        <button mat-menu-item (click)="openDetailsDialog(data._id)">
                          <mat-icon>visibility</mat-icon>
                          Details
                        </button>
                        <a mat-menu-item target="_blank"  [attr.href]="'//' + shop?.domain+'/product-details/'+data?.slug">
                          <mat-icon>visibility</mat-icon>
                          Details in website
                        </a>
                        <button mat-menu-item (click)="openConfirmDialog('clone', data._id)">
                          <mat-icon>content_copy</mat-icon>
                          Clone
                        </button>
                        <button mat-menu-item (click)="openBarcodePrintDialog([data])">
                          <mat-icon>qr_code_scanner</mat-icon>
                          Print Barcode
                        </button>
                      </mat-menu>
                    </td>
                  </tr>
                  <tr class="td-gap"></tr>
                </ng-container>
              }
            } @else {
              <tr>
                <td colspan="9">
                  <app-no-content
                    [matIcon]="'summarize'"
                    [title]="'No Data Found!'"
                    [desc]="'Please add some data to show here.'">
                  </app-no-content>
                </td>

              </tr>
            }

          } @placeholder (minimum 200ms) {
            <tr>
              <td colspan="9">
                <app-page-loader></app-page-loader>
              </td>
            </tr>
          }


        </table>

        <div class="pagination">
          <app-pagination
            [totalData]="totalData"
            [dataPerPage]="dataPerPage"
            [currentPage]="currentPage"
            (pageChange)="onPageChanged($event)">
          </app-pagination>
        </div>
      </div> <!-- END! table-wrapper -->

    </div> <!-- END! sub-content -->

  </div> <!-- END! content -->

</div> <!-- END! container -->


<!-- Bottom Action -->
<div class="bottom-action" [class.active]="selectedIds.length || isFilterChange">
  <div class="action-bar-left">
    <!--    <button (click)="clearSelectedItemByClick()" class="close-btn">-->
    <!--      <span class="material-icons">close</span>-->
    <!--    </button>-->


    <span class="items-selected">
      @if (selectedIds.length) {
        <span class="item-count">{{ selectedIds.length }}</span>
<!--        <button mat-raised-button color="primary" (click)="openBarcodePrintDialog()" class="action-btn">-->
<!--          <mat-icon>qr_code_scanner</mat-icon>-->
<!--          Print Barcode-->
<!--        </button>-->
      }
      @if (isFilterChange && !selectedIds.length) {
        Filter Applied
      } @else if (selectedIds.length && isFilterChange) {
        Items selected & Filter Applied
      } @else {
        Items selected
      }
    </span>

  </div>
  <div class="action-bar-right">
    @if (isFilterChange) {
      <button (click)="onClearDataQuery()" class="btn-black">
        <span class="material-icons">filter_alt_off</span> Clear Filter
      </button>
    }


    @if (selectedIds.length) {
      <button (click)="openBarcodePrintDialog()" class="btn-blue" style="background: #1976d2; color: white;">
        <mat-icon>qr_code_scanner</mat-icon> Print Barcode
      </button>

      <button (click)="onClearSelection()" class="btn-black">
        <span class="material-icons">clear</span> Clear Selection
      </button>

      <button [matMenuTriggerFor]="menuChangeStatus" class="btn-green">
        Change Status
        <span class="material-icons right-icon">arrow_drop_down</span>
      </button>

      <mat-menu #menuChangeStatus="matMenu">
        <button mat-menu-item (click)="openConfirmDialog('edit', {status: 'publish'})">Publish</button>
        <button mat-menu-item (click)="openConfirmDialog('edit', {status: 'draft'})">Draft</button>
      </mat-menu>

      <button (click)="openPopup()" class="btn-green">
       Tags
        <span class="material-icons right-icon">arrow_drop_down</span>
      </button>

<!--      <mat-menu #menuTags="matMenu">-->
<!--        <form #formElement="ngForm" [formGroup]="dataForm" (ngSubmit)="onSubmit()" class="area-border">-->


<!--        <mat-form-field appearance="outline" class="input-area">-->
<!--          <mat-label>Select Tag</mat-label>-->
<!--          <mat-select formControlName="tags" multiple>-->
<!--            <mat-option-->
<!--              *ngFor="let data of tags"-->
<!--              [value]="data._id"-->
<!--            >-->
<!--              {{ data.name }}-->
<!--            </mat-option>-->
<!--          </mat-select>-->
<!--          <mat-error>This field is required.</mat-error>-->
<!--        </mat-form-field>-->


<!--        <button type="submit">submit</button>-->
<!--        </form>-->
<!--      </mat-menu>-->

      <div class="popup-overlay" *ngIf="isPopupVisible">
        <div class="popup-content">
          <form #formElement="ngForm" [formGroup]="dataForm" (ngSubmit)="onSubmit()" class="area-border">

            <mat-form-field appearance="outline" class="input-area">
              <mat-label>Select Tag</mat-label>
              <mat-select formControlName="tags" multiple>
                <mat-option
                  *ngFor="let data of tags"
                  [value]="data._id"
                >
                  {{ data.name }}
                </mat-option>
              </mat-select>
              <mat-error>This field is required.</mat-error>
            </mat-form-field>

            <div class="popup-buttons">
              <button type="submit" class="submit-button">Submit</button>
              <button type="button" class="close-button" (click)="closePopup()">Close</button>
            </div>
          </form>
        </div>
      </div>


      <button (click)="openConfirmDialog('delete')" class="btn-red">
        <span class="material-icons">delete</span> Delete
      </button>
    }


  </div>
</div>
<!-- END! Bottom Action-->


<!-- Galley View -->
@if (isGalleryOpen) {
  <app-gallery-image-viewer
    [images]="galleryImages"
    [startIndex]="selectedImageIndex"
    (closeEvent)="closeGallery()">
  </app-gallery-image-viewer>
}
<!-- END Galley View -->






<!-- Import Results Dialog -->
<div class="import-results-overlay" *ngIf="showImportResults" (click)="onCloseImportResults()"></div>
<div class="import-results-panel" *ngIf="showImportResults">
  <div class="import-results-header">
    <h3>Import Results</h3>
    <button mat-icon-button (click)="onCloseImportResults()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="import-summary">
    <div class="success-count" *ngIf="importResults?.insertedCount > 0">
      <mat-icon class="success-icon">check_circle</mat-icon>
      <span>Successfully imported: {{importResults.insertedCount}} products</span>
    </div>

    <div class="error-count" *ngIf="importResults?.failedCount > 0">
      <mat-icon class="error-icon">error</mat-icon>
      <span>Failed to import: {{importResults.failedCount}} products</span>
    </div>
  </div>

  <div class="failed-imports" *ngIf="importResults?.failedProducts?.length > 0">
    <h4>Failed Products:</h4>
    <mat-accordion>
      <mat-expansion-panel *ngFor="let item of importResults.failedProducts; let i = index">
        <mat-expansion-panel-header>
          <mat-panel-title>
            {{i + 1}}. {{item.product?.name || 'Unnamed Product'}}
          </mat-panel-title>
          <mat-panel-description class="error-message">
            {{item.error || 'Unknown error'}}
          </mat-panel-description>
        </mat-expansion-panel-header>

        <div class="product-details">
          <div><strong>Brand:</strong> {{item.product?.brand || 'N/A'}}</div>
          <div><strong>Generic:</strong> {{item.product?.generic || 'N/A'}}</div>
          <div><strong>Dosage:</strong> {{item.product?.milligram || 'N/A'}}</div>
        </div>
      </mat-expansion-panel>
    </mat-accordion>
  </div>

  <div class="import-actions">
    <button mat-raised-button color="primary" (click)="onCloseImportResults()">Close</button>
  </div>
</div>


